<!DOCTYPE html>
<html>
    <head>
        <title>tanks_off</title>
        <style>
            .players_choose_button {
                width: 100%;
                height: 225px;
                display: block
            }
            .field {
                position: relative;
                width:  950px;
                height: 630px;
                background-color: #00ffff;
                margin: 30px;
                display: none;
                border-color: blueviolet;
            }
            .player {
                position: absolute;
                width: 35px;
                height: 35px;
                display: none;
                background-position: center !important;
                background-repeat: no-repeat !important;
            }

            .bullet {
                position: absolute;
                top: 30px;
                left: 30px;
                width: 3px;
                height: 8px;
                background: url("tanks_off/bullet.png");
            }

        </style>
    </head>
    <body>

        <div>
            <input id="players_choose_button_2" class="players_choose_button" type="button" value="2 players" style="background-color:greenyellow" onclick="start_game(2);" >
            <input id="players_choose_button_3" class="players_choose_button" type="button" value="3 players" style="background-color:yellow"      onclick="start_game(3);" >
            <input id="players_choose_button_4" class="players_choose_button" type="button" value="4 players" style="background-color:red"         onclick="start_game(4);" >
        </div>
        <div id="field" class="field">


            <div id="player1" class="player">
            </div>

            <div id="player2" class="player">
            </div>

            <div id="player3" class="player">
            </div>

            <div id="player4" class="player">
            </div>


        </div>
        <script>
            const KEY_SPASE = 32;
            const KEY_L = 76;
            var rotate_tank_1 = "top";
            var rotate_tank_2 = "top";
            var rotate_tank_3 = "top";
            var rotate_tank_4 = "top";
            

            var key_mapping = {
                16: {player_name: 'player1', action: 'bullet'},
                37: {player_name: 'player1', action: 'left'},
                39: {player_name: 'player1', action: 'right'},
                38: {player_name: 'player1', action: 'top'},
                40: {player_name: 'player1', action: 'bottom'},

                49: {player_name: 'player2', action: 'bullet'},
                65: {player_name: 'player2', action: 'left'},
                68: {player_name: 'player2', action: 'right'},
                87: {player_name: 'player2', action: 'top'},
                83: {player_name: 'player2', action: 'bottom'},

                KEY_SPASE: {player_name: 'player3', action: 'bullet'},
                74: {player_name: 'player3', action: 'left'},
                76: {player_name: 'player3', action: 'right'},
                73: {player_name: 'player3', action: 'top'},
                75: {player_name: 'player3', action: 'bottom'},

                13: {player_name: 'player4', action: 'bullet'},
                97: {player_name: 'player4', action: 'left'},
                99: {player_name: 'player4', action: 'right'},
                101: {player_name: 'player4', action: 'top'},
                98: {player_name: 'player4', action: 'bottom'}
            };

            function bullet (player) {
                var bullet = document.createElement("div");
                bullet.classList.add("bullet");
                document.getElementById("field").appendChild(bullet);
                var tank = document.getElementById(player);

                var posLeft = tank.offsetLeft;
                var posTop = tank.offsetTop;

                bullet.style.top = (posTop + 9) + "px";
                bullet.style.left = (posLeft + 12) + "px";


                if (rotate_tank_1 === "left") {
                    document.getElementById("field").lastChild.style.transform = "rotate( -100grad)";
                    setTimeout(handle_pressed_keys, TIMEOUT_BETWEEN_HANDLING);
                    // надо делать через таймауты, чотбы было видно движение
                    var i = 0;
                    while (i < 1) {
//                        console.log('+');
                        var posLeft = bullet.offsetLeft;
//                        console.log("was " + posLeft + ' and became ' + (posLeft + 10));
                        document.getElementById("field").lastChild.style.left = (posLeft + 10) + "px";
                        if (posLeft >= 950) {
                            i = 1;
//                            document.getElementById("field").lastChild.style = ("display: none");
                        }
                    }
                }
                if (rotate_tank_1 === "right") {
                    document.getElementById("field").lastChild.style.transform = "rotate( 100grad)";
                    // надо делать через таймауты, чотбы было видно движение
                    var i = 0;
                    while (i < 1) {
                        console.log('+');
                        var posLeft = bullet.offsetLeft;
                        console.log("was " + posLeft + ' and became ' + (posLeft - 10));
                        document.getElementById("field").lastChild.style.left = (posLeft - 10) + "px";
                        if (posLeft < 10) {
                            i = 1;
//                        document.getElementById("field").lastChild.style = ("display: none");
                        }
                    }
                }
                if (rotate_tank_1 === "top") {
                    document.getElementById("field").lastChild.style.transform = "rotate( 0grad)";
                    // надо делать через таймауты, чотбы было видно движение
                    var i = 0;
                    while (i < 1) {
                        console.log('+');
                        var posTop = bullet.offsetLeft;
                        console.log("was " + posTop + ' and became ' + (posTop - 10));
                        document.getElementById("field").lastChild.style.left = (posTop - 10) + "px";
                        if (posTop <= 0) {
                            i = 1;
//                            document.getElementById("field").lastChild.style = ("display: none");
                        }
                    }
                }
                if (rotate_tank_1 === "bottom") {
                    document.getElementById("field").lastChild.style.transform = "rotate( 200grad)";
                    // надо делать через таймауты, чотбы было видно движение
                    var i = 0;
                    while (i < 1) {
                        console.log('+');
                        var posTop = bullet.offsetLeft;
                        console.log("was " + posTop + ' and became ' + (posTop + 10));
                        document.getElementById("field").lastChild.style.left = (posTop + 10) + "px";
                        if (posTop >= 630) {
                            i = 1;
//                            document.getElementById("field").lastChild.style = ("display: none");
                        }
                    }
                }
            }

            var keys = {};
            function set_key_pressed(code, pressed) {
                keys[code] = pressed;
                console.log(keys);
            }
            
            document.onkeydown = function (event) {
                set_key_pressed(event.keyCode, true);
            };

            document.onkeyup = function (event) {
                set_key_pressed(event.keyCode, false);
            };

            function start_game(players) {
                document.getElementById("field").style = "display: block";
                console.log("игра началась с " + players + " игроками");

                for (var i = 2; i <= 4; i++) {
                    document.getElementById("players_choose_button_" + i).style = "display: none";
                }

                for (var i = 1; i <= players; i++) {
                    var tank = document.getElementById("player" + i);
                    tank.style = `background:url("tanks_off/${i}.png"); display: block`;
                }

                document.getElementById("player1").style.right = '0px';
                document.getElementById("player2").style.bottom = '0px';
                document.getElementById("player4").style.right = "0px";
                document.getElementById("player4").style.bottom = "0px";

                handle_pressed_keys();
            }
            
            start_game(4); // temp while developing



            function handle_pressed_keys() {
                const TIMEOUT_BETWEEN_HANDLING = 5;
                
                var step = 5;
                var posLeft = document.getElementById('player1').offsetLeft;
                var posTop = document.getElementById('player1').offsetTop;
//                console.log(posLeft);
//                console.log(posTop);
                //alert(posLeft + ' ' + posTop);
                var player_name = "player1";

/*
                for (var index in keys) {
                    if (!keys[index]) {
                        continue;
                    }

                    if (!key_mapping[index]) {
                        continue;
                    }

                    var key_data = key_mapping[index];

                    switch (key_data.action) {
                        case "bullet":
                            make_bullet(key_data.player_name);
                            break;
                        case "left":
                            move_left(key_data.player_name);
                            break;
                    }

                }
        */

                if (keys[37]) {

                        //alert('Left key pressed');
                        if (posLeft <= 0) {
                            return true;
                        }
                        console.log(posLeft - step);
                        document.getElementById(player_name).style.left = (posLeft - step) + "px";
                        console.log(document.getElementById(player_name).offsetLeft);
                        console.log(document.getElementById(player_name).style.left);
//                        document.getElementById('player1').style.right = 'auto';
                        document.getElementById(player_name).style.transform = "rotate(300grad)";
                        rotate_tank_1 = "left";
                }
                
                if (keys[38]) {
                        //alert('Up key pressed');
                        if (posTop <= 0) {
                            return true;
                        }
                        document.getElementById(player_name).style.top = (posTop - step) + "px";
                        document.getElementById(player_name).style.transform = "rotate(0grad)";
                        rotate_tank_1 = "top";
                    
                }

                if (keys[39]) {
                        //alert('Right key pressed');
                        if (posLeft >= 925) {
                            return true;
                        }
                        document.getElementById(player_name).style.left = (posLeft + step) + "px";
                        document.getElementById(player_name).style.transform = "rotate(100grad)";
                        rotate_tank_1 = "right";
                }

                if (keys[40]) {
                        //alert('Down key pressed');
                        if (posTop >= 795) {
                            return true;
                        }
                        ;
                        document.getElementById(player_name).style.top = (posTop + step) + "px";
                        document.getElementById(player_name).style.transform = "rotate(200grad)";
                        rotate_tank_1 = "bottom";
                }
                
                if (keys[KEY_L]) {
                    make_bullet(player_name);
                    console.log('should start a bullet');
                }

                setTimeout(handle_pressed_keys, TIMEOUT_BETWEEN_HANDLING);
            }
        </script>

    </body>
</html>